server {
        listen  443;
        server_name sso.classlinkproxy.icreondemoserver.com;
	set $shiv "shiv variable value";
        location / {
                auth_request /check;
		##auth_request_set $user $upstream_http_x_user;
		auth_request_set $user $upstream_http_Set_Cookie;
		proxy_set_header x-user $user;
		
		auth_request_set $gws $upstream_http_gwstoken;
		proxy_set_header x-gwstoken $gws;
		
		add_header X-data-gwstoken $gws;

		#header_filter_by_lua '
		#	local cookies = ngx.header.set_cookie
		#	if not cookies then return end
		#	local newcookies = {}
		#	for i, val in ipairs(cookies) do
		#		local newval = string.gsub(val, "([dD]omain)=[%w_-\\\\.]+", "%1=oneroster.com")
		#		table.insert(newcookies, newval)
		#	end
		#	ngx.header.set_cookie = newcookies
		#';
		
		#add_header X-debug-message $shiv;
		add_header X-data-message "http cookie = $http_cookie, upstream = $upstream_http_Set_Cookie = $http_cookie";
		#proxy_pass_header Set-Cookie;
		#add_header Cookie "SKS-$gws";

		proxy_pass_header Cookie;
		proxy_pass_header Set-Cookie;
		proxy_pass_header P3P;

		##proxy_set_header Set-Cookie "$http_cookie;KEY=VALUE";

		proxy_pass http://php.net/;
        }
        location = /check {
                #internal;
                proxy_pass http://localhost:9001/?tenant_id=2;

                proxy_pass_request_body off;

                proxy_set_header Content-length "";
		proxy_set_header X-Original-URI $request_uri;
		proxy_set_header Host $http_host;
		##proxy_set_header X-Real-IP $remote_addr;
		##proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		##proxy_set_header X-Forwarded-Proto $scheme;

		##add_header X-debug-auth "/check auth";
		set $token "Shiv default token";
		if ($http_cookie ~* "x-gwstoken=([^;]+)(?:;|$)") {
			set $token "$1";
		}
		proxy_set_header x-shiv $http_cookie;
                proxy_set_header X-gwstoken $token;
		#proxy_set_header X-Shiv-Token $http_cookie;
        }
}
